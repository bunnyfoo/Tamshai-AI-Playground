# Keycloak for Local Development (tamshai-playground)
# Bakes realm exports into the image to avoid Docker Desktop volume mount issues
#
# Usage:
#   docker compose build keycloak  (rebuilds with latest realm export)
#   docker compose up -d keycloak
#
# Why not volume mount?
#   Docker Desktop on Windows has known issues where mounted files don't reflect
#   changes made after container creation. By copying the file into the image,
#   we ensure `docker compose build --no-cache` always includes the latest config.

FROM quay.io/keycloak/keycloak:24.0

# Copy realm exports into the image (not mounted as volume)
# This ensures terraform destroy + apply always uses the latest files
# Keycloak imports all JSON files in /opt/keycloak/data/import/ on startup
COPY realm-export-dev.json /opt/keycloak/data/import/01-realm-tamshai-corp.json
COPY realm-export-customers-dev.json /opt/keycloak/data/import/02-realm-tamshai-customers.json

# Security: Explicitly run as keycloak user (UID 1000, inherited from base image)
# This makes the non-root user explicit for security scanners
USER 1000

# Default command for dev mode with realm import
ENTRYPOINT ["/opt/keycloak/bin/kc.sh"]
CMD ["start-dev", "--import-realm"]
